name: Create Konflux UI PR

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Set environment variables
        run: |
          echo "UPSTREAM_REPO=redhat-appstudio/infra-deployments" >> $GITHUB_ENV
          echo "FORK_REPO=sahil143/infra-deployments" >> $GITHUB_ENV
          echo "KUI_REPO=konflux-ci/konflux-ui" >> $GITHUB_ENV

      - name: Run create-kui-pr.sh script
        id: prepare_pr
        run: |
          chmod +x dev/create-kui-pr.sh
          dev/create-kui-pr.sh

      - name: Create Pull Request
        if: steps.prepare_pr.outputs.branch_name != ''
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          UPSTREAM_REPO="${{ env.UPSTREAM_REPO }}"
          FORK_REPO="${{ env.FORK_REPO }}"
          BRANCH_NAME="${{ steps.prepare_pr.outputs.branch_name }}"
          PR_TITLE="${{ steps.prepare_pr.outputs.pr_title }}"
          
          # Get the fork owner (username before /)
          FORK_OWNER="${FORK_REPO%%/*}"
          
          # Get upstream default branch
          BASE_BRANCH=$(gh repo view "$UPSTREAM_REPO" --json defaultBranchRef -q .defaultBranchRef.name 2>/dev/null || echo main)
          
          echo "Creating PR against ${UPSTREAM_REPO}:${BASE_BRANCH} from ${FORK_OWNER}:${BRANCH_NAME}"
          
          # Check for existing PR
          EXISTING_PR=$(gh pr list --repo "$UPSTREAM_REPO" --head "${FORK_OWNER}:${BRANCH_NAME}" --json url --jq '.[0].url' 2>/dev/null || true)
          
          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR already exists: $EXISTING_PR"
            echo "pr_url=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            # Create temporary file for PR body
            PR_BODY_FILE=$(mktemp)
            cat > "$PR_BODY_FILE" << 'EOF'
          ${{ steps.prepare_pr.outputs.changelog_content }}
          EOF
            
            PR_URL=$(gh pr create \
              --repo "$UPSTREAM_REPO" \
              --head "${FORK_OWNER}:${BRANCH_NAME}" \
              --base "$BASE_BRANCH" \
              --title "$PR_TITLE" \
              --body-file "$PR_BODY_FILE")
            
            rm -f "$PR_BODY_FILE"
            
            echo "Created PR: $PR_URL"
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          fi

      - name: Output PR URL
        if: steps.create_pr.outputs.pr_url != ''
        run: |
          echo "‚úÖ PR URL: ${{ steps.create_pr.outputs.pr_url }}"

      - name: Send Slack notification
        if: steps.create_pr.outputs.pr_url != ''
        run: |
          PR_URL="${{ steps.create_pr.outputs.pr_url }}"
          PR_TITLE="${{ steps.prepare_pr.outputs.pr_title }}"
          BASE_SHA="${{ steps.prepare_pr.outputs.base_sha }}"
          TARGET_SHA="${{ steps.prepare_pr.outputs.target_sha }}"
          KUI_REPO="${{ env.KUI_REPO }}"
          
          # Format SHA range for display (shortened)
          SHORT_BASE="${BASE_SHA:0:7}"
          SHORT_TARGET="${TARGET_SHA:0:7}"
          SHA_RANGE="${SHORT_BASE}...${SHORT_TARGET}"
          
          # Create JSON payload for Slack
          PAYLOAD=$(cat <<EOF
          {
            "text": "New Konflux UI PR Created - @konflux-ui",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üöÄ New Konflux UI PR Created"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*PR Title:*\n${PR_TITLE}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*SHA Range:*\n\`${SHA_RANGE}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*PR URL:*\n<${PR_URL}|View Pull Request>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${KUI_REPO}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "@konflux-ui Please review the changes in staging cluster.\n\n‚ö†Ô∏è *Note:* This PR deploys changes to production."
                }
              }
            ]
          }
          EOF
          )
          
          # Echo the message for now (uncomment curl below when ready to send to Slack)
          echo "Slack notification payload:"
          echo "$PAYLOAD"
          
          # Send to Slack webhook (commented out for now)
          # curl -X POST \
          #   -H 'Content-Type: application/json' \
          #   -d "$PAYLOAD" \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"
